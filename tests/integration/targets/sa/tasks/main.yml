---
- name: Var block
  vars:
    login_name: "PhillipJFry"
    plain_password: "P0pS3cret!23$%"
    password_expiration_enabled: false
    password_policy_enforced: false
    password_must_change: false
    status: "disabled"
  module_defaults:
    lowlydba.sqlserver.sa:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
  tags: ["sqlserver.login"]
  block:
    - name: Disable sa
      lowlydba.sqlserver.sa:
        password: "{{ plain_password }}"
        password_expiration_enabled: "{{ password_expiration_enabled }}"
        password_policy_enforced: "{{ password_policy_enforced }}"
        status: "{{ status }}"
        password_must_change: "{{ password_must_change }}"
      register: result
    - assert:
        that:
          - result.data != None
          - result.data.ComputerName != None
          - result.data.InstanceName != None
          - result.data.SqlInstance != None
          - result.data.IsDisabled is true
          - result.data.IsLocked is false
          - result.data.MustChangePassword is false
          - result.data.LoginName | default(result.data.Name) == "{{ login_name }}"

    - name: Enable in checkmode
      lowlydba.sqlserver.sa:
        status: "enabled"
      check_mode: true
      register: result
    - assert:
        that:
          - result is changed

    - name: Verify checkmode works
      lowlydba.sqlserver.sa:
        status: "enabled"
      register: result
    - assert:
        that:
          - result.data != None
          - result.data.ComputerName != None
          - result.data.InstanceName != None
          - result.data.SqlInstance != None
          - result.data.MustChangePassword is false
          - result.data.IsDisabled is false
          - result.data.IsLocked is false
          - result.data.LoginName | default(result.data.Name) == "{{ login_name }}"
          - result is changed
  always:
    - name: Enable sa
      lowlydba.sqlserver.sa:
        status: "enabled"
