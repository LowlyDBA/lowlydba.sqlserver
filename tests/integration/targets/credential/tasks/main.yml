---
- name: Var block
  vars:
    identity: "TestIdentity"
    name: "MrSmith"
    secure_password: "Password123!"
    mapped_class_type: "None"
    provider_name: ""
  tags: ["credential"]
  block:
    - name: Create new credential
      lowlydba.sqlserver.credential:
        sql_instance: "{{ sqlserver_instance }}"
        sql_username: "{{ sqlserver_username }}"
        sql_password: "{{ sqlserver_password }}"
        identity: "{{ identity }}"
        name: "{{ name }}"
        secure_password: "{{ secure_password }}"
      register: result
    - assert:
        that:
          - result.data != None
          - result.data.ComputerName != None
          - result.data.InstanceName != None
          - result.data.SqlInstance != None
          - result.data.Database == "{{ database }}"
          - result.data.Identity == "{{ identity }}"
          - result.data.Name == "{{ name }}"

    - name: Replace an existing credential
      lowlydba.sqlserver.credential:
        sql_instance: "{{ sqlserver_instance }}"
        sql_username: "{{ sqlserver_username }}"
        sql_password: "{{ sqlserver_password }}"
        identity: "{{ identity }}"
        force: true
      register: result
    - assert:
        that:
          - result.data != None
          - result.data.ComputerName != None
          - result.data.InstanceName != None
          - result.data.SqlInstance != None
          - result.data.Database == "{{ database }}"
          - result.data.Identity == "{{ identity }}"
          - result.data.Name == "{{ identity }}"

    - name: Drop a credential
      lowlydba.sqlserver.credential:
        state: "absent"
      register: result
    - assert:
        that:
          - result.data != None
          - result.data.ComputerName != None
          - result.data.InstanceName != None
          - result.data.SqlInstance != None
          - result is changed

    - name: Create credential in check mode
      lowlydba.sqlserver.credential:
        sql_instance: "{{ sqlserver_instance }}"
        sql_username: "{{ sqlserver_username }}"
        sql_password: "{{ sqlserver_password }}"
        identity: "{{ identity }}"
      register: result
      check_mode: true
    - assert:
        that:
          - result is changed

  always:
    - name: Drop credential
      lowlydba.sqlserver.credential:
        state: "absent"
