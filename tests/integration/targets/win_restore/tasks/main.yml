---
- name: Var block
  vars:
    database_name: "model"
    restore_database: "model_restore"
  module_defaults:
    lowlydba.sqlserver.backup:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
      database: "{{ database_name }}"
    lowlydba.sqlserver.restore:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
      database: "{{ restore_database }}"
  tags: ["restore"]
  block:
    - name: Backup a database
      lowlydba.sqlserver.backup:
      register: backup_result

    - name: Restore a database
      lowlydba.sqlserver.restore:
      register: result
    - assert:
        that:
          - result.data.SqlInstance != None
          - result.data.Database == "{{ restore_database }}"
